<!DOCTYPE html>
<html>
<head>
  <title>Register - Polisi KotakuV3</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="assets/js/auth.js"></script>
  <script type="module" src="assets/js/webhook.js"></script>
</head>
<body>
  <div class="register-container">
    <h1>REGISTER</h1>
    <form id="registerForm">
      <input type="text" id="nrp" placeholder="NRP" required>
      <input type="text" id="fullname" placeholder="Nama Lengkap" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Daftar</button>
    </form>
  </div>

  <script type="module">
    import { auth, db } from './assets/js/firebase.js';
    import { sendDiscordWebhook } from './assets/js/webhook.js';

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userData = {
        nrp: document.getElementById('nrp').value,
        fullname: document.getElementById('fullname').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        status: 'pending' // Status awal: menunggu persetujuan
      };

      try {
        // 1. Simpan data user ke Firebase Auth
        const userCredential = await auth.createUserWithEmailAndPassword(
          userData.email, 
          userData.password
        );

        // 2. Simpan data tambahan ke Firestore (pendingUsers)
        await db.collection('pendingUsers').doc(userCredential.user.uid).set(userData);

        // 3. Kirim notifikasi ke Discord Webhook
        await sendDiscordWebhook(userData);

        Swal.fire(
          'Berhasil!', 
          'Registrasi berhasil. Tunggu persetujuan admin.', 
          'success'
        );
      } catch (error) {
        Swal.fire('Error!', error.message, 'error');
      }
    });
  </script>
</body>
</html>