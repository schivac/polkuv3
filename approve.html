<!DOCTYPE html>
<html>
<head>
    <title>Approval System</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Fungsi untuk mendapatkan parameter URL
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            
            pairs.forEach(pair => {
                const [key, value] = pair.split('=');
                params[key] = decodeURIComponent(value);
            });
            
            return params;
        }

        // Fungsi utama
        async function processApproval() {
            const { nrp, token } = getUrlParams();
            
            // Validasi parameter
            if (!nrp || !token) {
                showError("Parameter tidak valid");
                return;
            }

            // Verifikasi token (contoh sederhana)
            const isValidToken = atob(token) === `approve_${nrp}`;
            
            if (!isValidToken) {
                showError("Token tidak valid");
                return;
            }

            // Tampilkan dialog konfirmasi
            const { isConfirmed } = await Swal.fire({
                title: 'Konfirmasi Persetujuan',
                html: `Anda yakin ingin menyetujui registrasi NRP <b>${nrp}</b>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Setujui',
                cancelButtonText: 'Batal'
            });

            if (isConfirmed) {
                // Simpan persetujuan (contoh menggunakan localStorage)
                const approvals = JSON.parse(localStorage.getItem('approvals') || '{}');
                approvals[nrp] = { status: 'approved', timestamp: new Date().toISOString() };
                localStorage.setItem('approvals', JSON.stringify(approvals));

                // Tampilkan notifikasi sukses
                await Swal.fire({
                    title: 'Berhasil!',
                    text: `Registrasi NRP ${nrp} telah disetujui`,
                    icon: 'success'
                });

                // Redirect atau tutup window
                window.close();
            } else {
                window.close();
            }
        }

        function showError(message) {
            Swal.fire({
                title: 'Error!',
                text: message,
                icon: 'error'
            }).then(() => {
                window.close();
            });
        }

        // Jalankan proses saat halaman dimuat
        document.addEventListener('DOMContentLoaded', processApproval);
    </script>
</head>
<body>
    <!-- Halaman kosong, semua diproses oleh JavaScript -->
</body>
</html>